#!/usr/bin/env bash

set -u

DATA_DIR="${HOME}/.work_chill"
STATE_FILE="${DATA_DIR}/state.sh"
LOGS_DIR="${DATA_DIR}/logs"
LOG_FILE_LINK="${DATA_DIR}/log.jsonl"
LOG_FILE="${LOG_FILE_LINK}"
LEGACY_LOG_FILE="${LOGS_DIR}/legacy-log.jsonl"
BG_LOG_FILE="${DATA_DIR}/bg.log"
SHUTDOWN_LOOKBACK_WEEKS=8
SCRIPT_PATH=""

DEFAULT_MEDITATION_URL="https://youtu.be/7CaaHXjoRhA?si=LMDnR8tb5zmGMRV-"
ESCALATION_BREAK_URL="https://www.youtube.com/watch?v=Ih-rtou1PTc"

day_start_ts=""
prompt_pid=""
eod_pid=""
meditation_url="$DEFAULT_MEDITATION_URL"
hand_yoga_url=""
hand_yoga_interval_secs="10800"
hand_yoga_max_per_day="2"
hand_yoga_count_today="0"
last_hand_yoga_ts=""
hand_yoga_snoozed_until=""
hand_yoga_pid=""
last_task_text=""
last_prompt_ts=""
last_escalation_ts=""
paused="no"
pause_started_ts=""
paused_total_secs="0"
day_length_secs=""
prompt_interval_secs=""
consecutive_same_count="0"
last_action=""

is_test_mode() {
  [[ "${WORK_CHILL_TEST:-0}" == "1" ]]
}

prompt_interval_sec() {
  if is_test_mode; then
    printf '10'
  else
    printf '3300'
  fi
}

day_length_sec() {
  if is_test_mode; then
    printf '120'
  else
    printf '28800'
  fi
}

escalation_break_timer_sec() {
  if is_test_mode; then
    printf '10'
  else
    printf '150'
  fi
}

int_or_default() {
  local value="${1:-}"
  local fallback="${2:-0}"
  if [[ "$value" =~ ^[0-9]+$ ]]; then
    printf '%s' "$value"
  else
    printf '%s' "$fallback"
  fi
}

state_prompt_interval_secs() {
  local interval
  interval="$(int_or_default "${prompt_interval_secs:-}" "0")"
  if [[ "$interval" -le 0 ]]; then
    interval="$(prompt_interval_sec)"
  fi
  printf '%s' "$interval"
}

state_day_length_secs() {
  local length
  length="$(int_or_default "${day_length_secs:-}" "0")"
  if [[ "$length" -le 0 ]]; then
    length="$(day_length_sec)"
  fi
  printf '%s' "$length"
}

state_hand_yoga_interval_secs() {
  local interval
  interval="$(int_or_default "${hand_yoga_interval_secs:-}" "0")"
  if [[ "$interval" -le 0 ]]; then
    interval="$(hand_yoga_interval_sec)"
  fi
  printf '%s' "$interval"
}

state_hand_yoga_max_per_day() {
  local max_per_day
  max_per_day="$(int_or_default "${hand_yoga_max_per_day:-}" "0")"
  if [[ "$max_per_day" -le 0 ]]; then
    max_per_day="2"
  fi
  printf '%s' "$max_per_day"
}

hand_yoga_enabled() {
  [[ -n "${hand_yoga_url:-}" ]]
}

effective_paused_total_secs() {
  local now="${1:-}"
  local total
  local delta=0
  total="$(int_or_default "${paused_total_secs:-}" "0")"

  if [[ "${paused:-no}" == "yes" && "${pause_started_ts:-}" =~ ^[0-9]+$ && "$now" =~ ^[0-9]+$ ]]; then
    if (( now > pause_started_ts )); then
      delta=$((now - pause_started_ts))
      total=$((total + delta))
    fi
  fi

  printf '%s' "$total"
}

compute_active_elapsed_secs() {
  local now="${1:-}"
  local elapsed=0
  local paused_secs=0
  local active=0

  if [[ -z "${day_start_ts:-}" || ! "${day_start_ts:-}" =~ ^[0-9]+$ || ! "$now" =~ ^[0-9]+$ ]]; then
    printf '0'
    return 0
  fi

  if (( now > day_start_ts )); then
    elapsed=$((now - day_start_ts))
  fi
  paused_secs="$(effective_paused_total_secs "$now")"
  active=$((elapsed - paused_secs))
  if (( active < 0 )); then
    active=0
  fi
  printf '%s' "$active"
}

compute_remaining_secs() {
  local now="${1:-}"
  local length active remaining
  length="$(state_day_length_secs)"
  active="$(compute_active_elapsed_secs "$now")"
  remaining=$((length - active))
  if (( remaining < 0 )); then
    remaining=0
  fi
  printf '%s' "$remaining"
}

is_valid_hhmm() {
  local hhmm="${1:-}"
  [[ "$hhmm" =~ ^([01][0-9]|2[0-3]):([0-5][0-9])$ ]]
}

seconds_until_end_at() {
  local hhmm="${1:-}"
  local now=""
  local today=""
  local target=""

  is_valid_hhmm "$hhmm" || return 1

  now="$(date +%s)"
  today="$(date +"%Y-%m-%d")"
  target="$(date -j -f "%Y-%m-%d %H:%M" "$today $hhmm" +%s 2>/dev/null || true)"
  [[ -n "$target" ]] || return 1

  if (( target <= now )); then
    target="$(date -j -v+1d -f "%Y-%m-%d %H:%M" "$today $hhmm" +%s 2>/dev/null || true)"
    [[ -n "$target" ]] || return 1
  fi

  printf '%s' "$((target - now))"
}

meditation_timer_sec() {
  if is_test_mode; then
    printf '15'
  else
    printf '360'
  fi
}

hand_yoga_interval_sec() {
  if is_test_mode; then
    printf '30'
  else
    printf '10800'
  fi
}

hand_yoga_snooze_sec() {
  if is_test_mode; then
    printf '5'
  else
    printf '1200'
  fi
}

hand_yoga_defer_sec() {
  printf '600'
}

resolve_script_path() {
  local src="${BASH_SOURCE[0]:-$0}"
  local resolved=""
  if [[ "$src" = /* ]]; then
    resolved="$src"
  else
    resolved="$(command -v "$src" 2>/dev/null || true)"
    if [[ -z "$resolved" ]]; then
      resolved="$(cd "$(dirname "$src")" && pwd -P)/$(basename "$src")"
    fi
  fi
  printf '%s' "$resolved"
}

pulse_dialog_timeout_sec() {
  if is_test_mode; then
    printf '5'
  else
    printf '45'
  fi
}

shutdown_input_timeout_sec() {
  if is_test_mode; then
    printf '5'
  else
    printf '180'
  fi
}

confirm_timeout_sec() {
  if is_test_mode; then
    printf '3'
  else
    printf '45'
  fi
}

iso_ts() {
  date -u +"%Y-%m-%dT%H:%M:%SZ"
}

current_iso_week() {
  local week=""
  week="$(date +%G-W%V 2>/dev/null || true)"
  if [[ "$week" =~ ^[0-9]{4}-W[0-9]{2}$ ]]; then
    printf '%s' "$week"
  else
    date +%Y-W%W
  fi
}

current_week_log_file() {
  printf '%s/%s.jsonl' "$LOGS_DIR" "$(current_iso_week)"
}

migrate_legacy_log_file_if_needed() {
  [[ -e "$LOG_FILE_LINK" && ! -L "$LOG_FILE_LINK" ]] || return 0
  [[ -f "$LOG_FILE_LINK" ]] || return 1

  if [[ ! -e "$LEGACY_LOG_FILE" ]]; then
    mv "$LOG_FILE_LINK" "$LEGACY_LOG_FILE"
  else
    cat "$LOG_FILE_LINK" >> "$LEGACY_LOG_FILE"
    rm -f "$LOG_FILE_LINK"
  fi
  chmod 600 "$LEGACY_LOG_FILE" 2>/dev/null || true
}

sync_log_symlink() {
  local weekly_log="${1:-}"
  [[ -n "$weekly_log" ]] || return 1

  if [[ -e "$LOG_FILE_LINK" && ! -L "$LOG_FILE_LINK" ]]; then
    migrate_legacy_log_file_if_needed || true
  fi

  if [[ -L "$LOG_FILE_LINK" ]]; then
    local current_target=""
    current_target="$(readlink "$LOG_FILE_LINK" 2>/dev/null || true)"
    if [[ "$current_target" != "$weekly_log" ]]; then
      ln -sfn "$weekly_log" "$LOG_FILE_LINK"
    fi
  elif [[ ! -e "$LOG_FILE_LINK" ]]; then
    ln -s "$weekly_log" "$LOG_FILE_LINK"
  fi
}

refresh_log_targets() {
  local weekly_log=""
  mkdir -p "$LOGS_DIR"
  weekly_log="$(current_week_log_file)"
  LOG_FILE="$weekly_log"
  touch "$LOG_FILE"
  chmod 600 "$LOG_FILE" 2>/dev/null || true
  sync_log_symlink "$LOG_FILE"
}

json_escape() {
  local s="${1:-}"
  s=${s//\\/\\\\}
  s=${s//\"/\\\"}
  s=${s//$'\n'/\\n}
  s=${s//$'\r'/\\r}
  s=${s//$'\t'/\\t}
  printf '%s' "$s"
}

ensure_data_dir() {
  mkdir -p "$DATA_DIR" "$LOGS_DIR"
  touch "$STATE_FILE" "$BG_LOG_FILE"
  chmod 600 "$STATE_FILE" "$BG_LOG_FILE" 2>/dev/null || true
  refresh_log_targets
}

save_state() {
  ensure_data_dir
  {
    printf 'export day_start_ts=%q\n' "${day_start_ts:-}"
    printf 'export prompt_pid=%q\n' "${prompt_pid:-}"
    printf 'export eod_pid=%q\n' "${eod_pid:-}"
    printf 'export hand_yoga_pid=%q\n' "${hand_yoga_pid:-}"
    printf 'export meditation_url=%q\n' "${meditation_url:-}"
    printf 'export hand_yoga_url=%q\n' "${hand_yoga_url:-}"
    printf 'export hand_yoga_interval_secs=%q\n' "${hand_yoga_interval_secs:-10800}"
    printf 'export hand_yoga_max_per_day=%q\n' "${hand_yoga_max_per_day:-2}"
    printf 'export hand_yoga_count_today=%q\n' "${hand_yoga_count_today:-0}"
    printf 'export last_hand_yoga_ts=%q\n' "${last_hand_yoga_ts:-}"
    printf 'export hand_yoga_snoozed_until=%q\n' "${hand_yoga_snoozed_until:-}"
    printf 'export last_task_text=%q\n' "${last_task_text:-}"
    printf 'export last_prompt_ts=%q\n' "${last_prompt_ts:-}"
    printf 'export last_escalation_ts=%q\n' "${last_escalation_ts:-}"
    printf 'export paused=%q\n' "${paused:-no}"
    printf 'export pause_started_ts=%q\n' "${pause_started_ts:-}"
    printf 'export paused_total_secs=%q\n' "${paused_total_secs:-0}"
    printf 'export day_length_secs=%q\n' "${day_length_secs:-}"
    printf 'export prompt_interval_secs=%q\n' "${prompt_interval_secs:-}"
    printf 'export consecutive_same_count=%q\n' "${consecutive_same_count:-0}"
    printf 'export last_action=%q\n' "${last_action:-}"
  } > "$STATE_FILE"
}

load_state() {
  day_start_ts=""
  prompt_pid=""
  eod_pid=""
  hand_yoga_pid=""
  meditation_url="$DEFAULT_MEDITATION_URL"
  hand_yoga_url=""
  hand_yoga_interval_secs="$(hand_yoga_interval_sec)"
  hand_yoga_max_per_day="2"
  hand_yoga_count_today="0"
  last_hand_yoga_ts=""
  hand_yoga_snoozed_until=""
  last_task_text=""
  last_prompt_ts=""
  last_escalation_ts=""
  paused="no"
  pause_started_ts=""
  paused_total_secs="0"
  day_length_secs=""
  prompt_interval_secs=""
  consecutive_same_count="0"
  last_action=""

  if [[ -f "$STATE_FILE" ]]; then
    # shellcheck disable=SC1090
    source "$STATE_FILE"
  fi

  paused="${paused:-no}"
  if [[ "$paused" != "yes" ]]; then
    paused="no"
  fi
  pause_started_ts="$(int_or_default "${pause_started_ts:-}" "0")"
  if [[ "$pause_started_ts" -eq 0 ]]; then
    pause_started_ts=""
  fi
  paused_total_secs="$(int_or_default "${paused_total_secs:-}" "0")"
  day_length_secs="$(int_or_default "${day_length_secs:-}" "0")"
  if [[ "$day_length_secs" -eq 0 ]]; then
    day_length_secs="$(day_length_sec)"
  fi
  prompt_interval_secs="$(int_or_default "${prompt_interval_secs:-}" "0")"
  if [[ "$prompt_interval_secs" -eq 0 ]]; then
    prompt_interval_secs="$(prompt_interval_sec)"
  fi
  hand_yoga_interval_secs="$(int_or_default "${hand_yoga_interval_secs:-}" "0")"
  if [[ "$hand_yoga_interval_secs" -le 0 ]]; then
    hand_yoga_interval_secs="$(hand_yoga_interval_sec)"
  fi
  hand_yoga_max_per_day="$(int_or_default "${hand_yoga_max_per_day:-}" "0")"
  if [[ "$hand_yoga_max_per_day" -le 0 ]]; then
    hand_yoga_max_per_day="2"
  fi
  hand_yoga_count_today="$(int_or_default "${hand_yoga_count_today:-}" "0")"
  if [[ "$hand_yoga_count_today" -lt 0 ]]; then
    hand_yoga_count_today="0"
  fi
  last_hand_yoga_ts="$(int_or_default "${last_hand_yoga_ts:-}" "0")"
  if [[ "$last_hand_yoga_ts" -eq 0 ]]; then
    last_hand_yoga_ts=""
  fi
  hand_yoga_snoozed_until="$(int_or_default "${hand_yoga_snoozed_until:-}" "0")"
  if [[ "$hand_yoga_snoozed_until" -eq 0 ]]; then
    hand_yoga_snoozed_until=""
  fi
  last_escalation_ts="$(int_or_default "${last_escalation_ts:-}" "0")"
  if [[ "$last_escalation_ts" -eq 0 ]]; then
    last_escalation_ts=""
  fi
  consecutive_same_count="$(int_or_default "${consecutive_same_count:-}" "0")"
  last_action="${last_action:-}"
}

log_event() {
  local event="${1:-}"
  local action="${2:-}"
  local task_text="${3:-}"
  local tomorrow_first_step="${4:-}"
  local open_items="${5:-}"
  local json=""

  ensure_data_dir
  json='{'
  json+="$(log_json_kv "ts" "$(iso_ts)")"
  json+=",$(log_json_kv "event" "$event")"
  json+=",$(log_json_kv "action" "$action")"

  case "$event" in
    "DAY_START")
      json+=",$(log_json_kv "day_start_ts" "${day_start_ts:-}")"
      ;;
    "TASK_PULSE")
      json+=",$(log_json_kv "task_text" "$task_text")"
      json+=",$(log_json_kv "day_start_ts" "${day_start_ts:-}")"
      ;;
    "TASK_PULSE_SKIPPED")
      json+=",$(log_json_kv "day_start_ts" "${day_start_ts:-}")"
      ;;
    "PAUSE")
      json+=",$(log_json_kv "day_start_ts" "${day_start_ts:-}")"
      json+=",$(log_json_kv "active_elapsed_secs" "$task_text")"
      ;;
    "RESUME")
      json+=",$(log_json_kv "day_start_ts" "${day_start_ts:-}")"
      json+=",$(log_json_kv "paused_delta_secs" "$task_text")"
      ;;
    "ESCALATION")
      json+=",$(log_json_kv "day_start_ts" "${day_start_ts:-}")"
      json+=",$(log_json_kv "choice" "$action")"
      case "$action" in
        "blocker")
          json+=",$(log_json_kv "blocker_text" "$task_text")"
          ;;
        "next_step")
          json+=",$(log_json_kv "next_step_text" "$task_text")"
          ;;
      esac
      ;;
    "SHUTDOWN")
      json+=",$(log_json_kv "task_text" "$task_text")"
      json+=",$(log_json_kv "day_start_ts" "${day_start_ts:-}")"
      json+=",$(log_json_kv "tomorrow_first_step" "$tomorrow_first_step")"
      json+=",$(log_json_kv "open_items" "$open_items")"
      ;;
    "CANCEL")
      ;;
    *)
      if [[ -n "$task_text" ]]; then
        json+=",$(log_json_kv "task_text" "$task_text")"
      fi
      if [[ -n "${day_start_ts:-}" ]]; then
        json+=",$(log_json_kv "day_start_ts" "${day_start_ts:-}")"
      fi
      if [[ -n "$tomorrow_first_step" ]]; then
        json+=",$(log_json_kv "tomorrow_first_step" "$tomorrow_first_step")"
      fi
      if [[ -n "$open_items" ]]; then
        json+=",$(log_json_kv "open_items" "$open_items")"
      fi
      ;;
  esac

  json+='}'
  printf '%s\n' "$json" >> "$LOG_FILE"
}

log_json_kv() {
  local key="${1:-}"
  local value="${2:-}"
  printf '"%s":"%s"' "$(json_escape "$key")" "$(json_escape "$value")"
}

pid_alive() {
  local pid="${1:-}"
  [[ -n "$pid" && "$pid" =~ ^[0-9]+$ ]] || return 1
  kill -0 "$pid" 2>/dev/null
}

pid_looks_like_work_chill() {
  local pid="${1:-}"
  local marker="${2:-}"
  local cmd=""
  pid_alive "$pid" || return 1
  cmd="$(ps -p "$pid" -o command= 2>/dev/null || true)"
  [[ "$cmd" == *"work_chill"* && "$cmd" == *"$marker"* ]]
}

kill_pid_if_ours() {
  local pid="${1:-}"
  local marker="${2:-}"
  [[ -n "$pid" ]] || return 0
  [[ "$pid" =~ ^[0-9]+$ ]] || return 0
  [[ "$pid" != "$$" ]] || return 0

  if pid_looks_like_work_chill "$pid" "$marker"; then
    kill "$pid" 2>/dev/null || true
    sleep 0.1
    if pid_alive "$pid"; then
      kill -9 "$pid" 2>/dev/null || true
    fi
  fi
}

cancel_jobs_in_memory() {
  kill_pid_if_ours "${prompt_pid:-}" "__prompt-loop"
  kill_pid_if_ours "${eod_pid:-}" "__eod-wait"
  kill_pid_if_ours "${hand_yoga_pid:-}" "__hand-yoga-loop"
  prompt_pid=""
  eod_pid=""
  hand_yoga_pid=""
}

cancel_jobs_only() {
  load_state
  cancel_jobs_in_memory
}

reset_active_day_state() {
  day_start_ts=""
  prompt_pid=""
  eod_pid=""
  hand_yoga_pid=""
  last_prompt_ts=""
  last_escalation_ts=""
  paused="no"
  pause_started_ts=""
  paused_total_secs="0"
  day_length_secs="$(day_length_sec)"
  prompt_interval_secs="$(prompt_interval_sec)"
  consecutive_same_count="0"
  last_action=""
}

resolve_button_from_osascript_output() {
  local out="${1:-}"
  printf '%s' "$out" | sed -n 's/^button returned://p'
}

prompt_action_osascript() {
  local out=""
  local parsed=""
  local rc=0
  local timeout
  local tmp_err=""
  local stderr_text=""
  timeout="$(pulse_dialog_timeout_sec)"
  tmp_err="$(mktemp "${TMPDIR:-/tmp}/work_chill_prompt.XXXXXX")"
  out="$(osascript <<APPLESCRIPT 2>"$tmp_err"
activate
set d to display dialog "What are you on right now?" with title "Friction Check" buttons {"Same as last", "New task", "Stuck"} default button "Same as last" giving up after $timeout
if gave up of d then return "Skip"
return button returned of d
APPLESCRIPT
)"
  rc=$?
  stderr_text="$(single_line "$(cat "$tmp_err" 2>/dev/null || true)")"
  rm -f "$tmp_err"

  bg_log "prompt_dialog rc=$rc output=\"$(single_line "$out")\" stderr=\"$stderr_text\""

  if [[ "$rc" -ne 0 ]]; then
    if [[ "$stderr_text" == *"(-128)"* ]]; then
      bg_log "prompt_dialog_canceled treated_as=\"Skip\""
      printf 'Skip'
      return 0
    fi
    notify_message "Friction Check prompt failed. Defaulting to Skip." "Work Chill"
    bg_log "prompt_dialog_fallback notification_sent=1 reason=\"osascript_failed\""
    return 1
  fi

  parsed="$out"
  if [[ "$parsed" != "Skip" && "$parsed" != "Same as last" && "$parsed" != "New task" && "$parsed" != "Stuck" ]]; then
    parsed="$(resolve_button_from_osascript_output "$out")"
  fi

  if [[ "$parsed" == "Skip" || "$parsed" == "Same as last" || "$parsed" == "New task" || "$parsed" == "Stuck" ]]; then
    printf '%s' "$parsed"
    return 0
  fi

  notify_message "Friction Check prompt response was invalid. Defaulting to Skip." "Work Chill"
  bg_log "prompt_dialog_fallback notification_sent=1 reason=\"unexpected_output\""
  return 1
}

prompt_action_terminal() {
  local choice=""
  printf '\nFriction Check\n'
  printf 'What are you on right now?\n'
  printf '1) Same as last\n'
  printf '2) New task\n'
  printf '3) Stuck\n'
  printf '4) Skip\n'
  printf 'Choose [1-4]: '
  IFS= read -r choice
  case "$choice" in
    1) printf 'Same as last' ;;
    2) printf 'New task' ;;
    3) printf 'Stuck' ;;
    *) printf 'Skip' ;;
  esac
}

get_action_choice() {
  local action=""
  case "${WORK_CHILL_FORCE_ACTION:-}" in
    "same_as_last") printf 'Same as last'; return 0 ;;
    "new_task") printf 'New task'; return 0 ;;
    "stuck") printf 'Stuck'; return 0 ;;
    "skip") printf 'Skip'; return 0 ;;
  esac

  action="$(prompt_action_osascript || true)"
  if [[ -n "$action" ]]; then
    printf '%s' "$action"
    return 0
  fi

  if [[ -t 0 ]]; then
    bg_log "prompt_dialog_fallback mode=\"terminal\""
    prompt_action_terminal
  else
    bg_log "prompt_dialog_fallback mode=\"skip_no_tty\""
    printf 'Skip'
  fi
}

escalation_choice_osascript() {
  local out=""
  local rc=0
  local timeout
  local tmp_err=""
  local stderr_text=""
  timeout="$(pulse_dialog_timeout_sec)"
  tmp_err="$(mktemp "${TMPDIR:-/tmp}/work_chill_escalation.XXXXXX")"
  out="$(osascript <<APPLESCRIPT 2>"$tmp_err"
activate
set d to display dialog "You've been on the same thing for a while (or marked stuck).
Take 10 seconds to reset." with title "Quick reset" buttons {"2-min break", "Name blocker", "Next micro-step"} default button "Next micro-step" giving up after $timeout
if gave up of d then return "Ignore"
return button returned of d
APPLESCRIPT
)"
  rc=$?
  stderr_text="$(single_line "$(cat "$tmp_err" 2>/dev/null || true)")"
  rm -f "$tmp_err"

  bg_log "escalation_dialog rc=$rc output=\"$(single_line "$out")\" stderr=\"$stderr_text\""

  if [[ "$rc" -ne 0 ]]; then
    if [[ "$stderr_text" == *"(-128)"* ]]; then
      printf 'Ignore'
      return 0
    fi
    return 1
  fi

  if [[ "$out" == "2-min break" || "$out" == "Name blocker" || "$out" == "Next micro-step" || "$out" == "Ignore" ]]; then
    printf '%s' "$out"
    return 0
  fi

  out="$(resolve_button_from_osascript_output "$out")"
  if [[ "$out" == "2-min break" || "$out" == "Name blocker" || "$out" == "Next micro-step" ]]; then
    printf '%s' "$out"
    return 0
  fi
  printf 'Ignore'
}

escalation_choice_terminal() {
  local choice=""
  printf '\nQuick reset\n'
  printf '1) 2-min break\n'
  printf '2) Name blocker\n'
  printf '3) Next micro-step\n'
  printf '4) Ignore\n'
  printf 'Choose [1-4]: '
  IFS= read -r choice
  case "$choice" in
    1) printf '2-min break' ;;
    2) printf 'Name blocker' ;;
    3) printf 'Next micro-step' ;;
    *) printf 'Ignore' ;;
  esac
}

get_escalation_choice() {
  local choice=""
  case "${WORK_CHILL_FORCE_ESCALATION_CHOICE:-}" in
    "break") printf '2-min break'; return 0 ;;
    "blocker") printf 'Name blocker'; return 0 ;;
    "next_step") printf 'Next micro-step'; return 0 ;;
    "ignore") printf 'Ignore'; return 0 ;;
  esac

  choice="$(escalation_choice_osascript || true)"
  if [[ -n "$choice" ]]; then
    printf '%s' "$choice"
    return 0
  fi

  if [[ -t 0 ]]; then
    escalation_choice_terminal
    return 0
  fi

  printf 'Ignore'
}

hand_yoga_action_osascript() {
  local out=""
  local rc=0
  local timeout
  local tmp_err=""
  local stderr_text=""
  timeout="$(pulse_dialog_timeout_sec)"
  tmp_err="$(mktemp "${TMPDIR:-/tmp}/work_chill_hand_yoga.XXXXXX")"
  out="$(osascript <<APPLESCRIPT 2>"$tmp_err"
activate
set d to display dialog "Quick 5-6 minute hand reset to keep things loose." with title "âœ‹ Hand reset" buttons {"Do it now", "Snooze 20m", "Skip today"} default button "Snooze 20m" giving up after $timeout
if gave up of d then return "Snooze 20m"
return button returned of d
APPLESCRIPT
)"
  rc=$?
  stderr_text="$(single_line "$(cat "$tmp_err" 2>/dev/null || true)")"
  rm -f "$tmp_err"

  bg_log "hand_yoga_dialog rc=$rc output=\"$(single_line "$out")\" stderr=\"$stderr_text\""

  if [[ "$rc" -ne 0 ]]; then
    if [[ "$stderr_text" == *"(-128)"* ]]; then
      printf 'Snooze 20m'
      return 0
    fi
    return 1
  fi

  if [[ "$out" == "Do it now" || "$out" == "Snooze 20m" || "$out" == "Skip today" ]]; then
    printf '%s' "$out"
    return 0
  fi

  out="$(resolve_button_from_osascript_output "$out")"
  if [[ "$out" == "Do it now" || "$out" == "Snooze 20m" || "$out" == "Skip today" ]]; then
    printf '%s' "$out"
    return 0
  fi

  printf 'Snooze 20m'
}

hand_yoga_action_terminal() {
  local choice=""
  printf '\nHand reset\n'
  printf '1) Do it now\n'
  printf '2) Snooze 20m\n'
  printf '3) Skip today\n'
  printf 'Choose [1-3]: '
  IFS= read -r choice
  case "$choice" in
    1) printf 'Do it now' ;;
    3) printf 'Skip today' ;;
    *) printf 'Snooze 20m' ;;
  esac
}

get_hand_yoga_action() {
  local action=""
  case "${WORK_CHILL_FORCE_HAND_YOGA_CHOICE:-}" in
    "start") printf 'Do it now'; return 0 ;;
    "snooze") printf 'Snooze 20m'; return 0 ;;
    "skip_day") printf 'Skip today'; return 0 ;;
  esac

  action="$(hand_yoga_action_osascript || true)"
  if [[ -n "$action" ]]; then
    printf '%s' "$action"
    return 0
  fi

  if [[ -t 0 ]]; then
    hand_yoga_action_terminal
    return 0
  fi

  printf 'Snooze 20m'
}

text_input_osascript() {
  local prompt="${1:-}"
  local title="${2:-Work Chill}"
  local timeout
  timeout="$(shutdown_input_timeout_sec)"
  osascript <<APPLESCRIPT 2>/dev/null
set d to display dialog "$(printf '%s' "$prompt" | sed 's/"/\\"/g')" with title "$(printf '%s' "$title" | sed 's/"/\\"/g')" default answer "" buttons {"Cancel", "OK"} default button "OK" giving up after $timeout
if gave up of d then return ""
text returned of d
APPLESCRIPT
}

text_input_terminal() {
  local prompt="${1:-}"
  local value=""
  printf '%s ' "$prompt"
  IFS= read -r value
  printf '%s' "$value"
}

get_text_input() {
  local prompt="${1:-}"
  local title="${2:-Work Chill}"
  local value=""
  value="$(text_input_osascript "$prompt" "$title" || true)"
  if [[ -n "$value" ]]; then
    printf '%s' "$value"
    return 0
  fi
  if [[ -t 0 ]]; then
    text_input_terminal "$prompt"
    return 0
  fi
  printf ''
}

confirm_ok() {
  local message="${1:-}"
  local title="${2:-Work Chill}"
  local timeout
  timeout="$(confirm_timeout_sec)"
  if ! osascript <<APPLESCRIPT >/dev/null 2>&1
display dialog "$(printf '%s' "$message" | sed 's/"/\\"/g')" with title "$(printf '%s' "$title" | sed 's/"/\\"/g')" buttons {"OK"} default button "OK" giving up after $timeout
APPLESCRIPT
  then
    if [[ -t 0 ]]; then
      printf '%s\nPress Enter to continue...' "$message"
      read -r _
    fi
  fi
}

notify_message() {
  local message="${1:-}"
  local title="${2:-Work Chill}"
  osascript -e "display notification \"$(printf '%s' "$message" | sed 's/"/\\"/g')\" with title \"$(printf '%s' "$title" | sed 's/"/\\"/g')\"" >/dev/null 2>&1 || true
}

single_line() {
  local s="${1:-}"
  printf '%s' "$s" | tr '\n\r\t' '   ' | sed 's/[[:space:]]\+/ /g; s/^ //; s/ $//'
}

bg_log() {
  local message="${1:-}"
  ensure_data_dir
  printf '%s %s\n' "$(iso_ts)" "$(single_line "$message")" >> "$BG_LOG_FILE" 2>/dev/null || true
}

json_unescape_best_effort() {
  local s="${1:-}"
  s="${s//\\\"/\"}"
  s="${s//\\\\/\\}"
  printf '%s' "$s"
}

extract_json_field_between() {
  local line="${1:-}"
  local start="${2:-}"
  local end="${3:-}"
  local value=""
  [[ -n "$line" && -n "$start" && -n "$end" ]] || return 1
  [[ "$line" == *"$start"* ]] || return 1
  value="${line#*"$start"}"
  value="${value%%"$end"*}"
  printf '%s' "$value"
}

latest_shutdown_line_in_file() {
  local file="${1:-}"
  local line=""
  [[ -f "$file" ]] || return 1

  line="$(tail -r "$file" 2>/dev/null | grep -m 1 '"event":"SHUTDOWN"' || true)"
  if [[ -z "$line" ]] && command -v tac >/dev/null 2>&1; then
    line="$(tac "$file" 2>/dev/null | grep -m 1 '"event":"SHUTDOWN"' || true)"
  fi
  if [[ -z "$line" ]]; then
    line="$(grep '"event":"SHUTDOWN"' "$file" 2>/dev/null | tail -n 1 || true)"
  fi

  [[ -n "$line" ]] || return 1
  printf '%s' "$line"
}

recent_previous_weekly_logs() {
  local max_files="${1:-8}"
  local count=0
  local file=""
  [[ -d "$LOGS_DIR" ]] || return 0

  while IFS= read -r file; do
    [[ "$file" == "$LOG_FILE" ]] && continue
    [[ -f "$file" ]] || continue
    printf '%s\n' "$file"
    count=$((count + 1))
    if (( count >= max_files )); then
      break
    fi
  done < <(ls -1 "$LOGS_DIR"/????-W??.jsonl 2>/dev/null | sort -r)
}

latest_shutdown_log_line() {
  local line=""
  local file=""

  line="$(latest_shutdown_line_in_file "$LOG_FILE" || true)"
  if [[ -n "$line" ]]; then
    printf '%s' "$line"
    return 0
  fi

  while IFS= read -r file; do
    line="$(latest_shutdown_line_in_file "$file" || true)"
    if [[ -n "$line" ]]; then
      printf '%s' "$line"
      return 0
    fi
  done < <(recent_previous_weekly_logs "$SHUTDOWN_LOOKBACK_WEEKS")

  line="$(latest_shutdown_line_in_file "$LEGACY_LOG_FILE" || true)"
  [[ -n "$line" ]] || return 1
  printf '%s' "$line"
}

parse_shutdown_context_from_line() {
  local line="${1:-}"
  local parsed=""
  last_shutdown_ts=""
  last_shutdown_task_text=""
  last_shutdown_tomorrow_first_step=""
  last_shutdown_open_items=""

  [[ -n "$line" ]] || return 1

  if command -v jq >/dev/null 2>&1; then
    parsed="$(printf '%s\n' "$line" | jq -r '[.ts // "", .task_text // "", .tomorrow_first_step // "", .open_items // ""] | @tsv' 2>/dev/null || true)"
    if [[ -n "$parsed" ]]; then
      IFS=$'\t' read -r last_shutdown_ts last_shutdown_task_text last_shutdown_tomorrow_first_step last_shutdown_open_items <<< "$parsed"
      return 0
    fi
  fi

  last_shutdown_ts="$(extract_json_field_between "$line" '"ts":"' '","event":"' || true)"
  last_shutdown_task_text="$(extract_json_field_between "$line" '"task_text":"' '","day_start_ts":"' || true)"
  last_shutdown_tomorrow_first_step="$(extract_json_field_between "$line" '"tomorrow_first_step":"' '","open_items":"' || true)"
  last_shutdown_open_items="$(extract_json_field_between "$line" '"open_items":"' '"}' || true)"

  last_shutdown_ts="$(json_unescape_best_effort "$last_shutdown_ts")"
  last_shutdown_task_text="$(json_unescape_best_effort "$last_shutdown_task_text")"
  last_shutdown_tomorrow_first_step="$(json_unescape_best_effort "$last_shutdown_tomorrow_first_step")"
  last_shutdown_open_items="$(json_unescape_best_effort "$last_shutdown_open_items")"

  return 0
}

append_welcome_section() {
  local header="${1:-}"
  local body="${2:-}"
  local current="${3:-}"
  local next=""

  if [[ -z "$body" ]]; then
    printf '%s' "$current"
    return 0
  fi

  next="$current"
  if [[ -n "$next" ]]; then
    next+=$'\n\n'
  fi
  next+="$header"
  next+=$'\n'
  next+="$body"
  printf '%s' "$next"
}

show_welcome_back_summary() {
  local line=""
  local message=""
  local timeout=45
  local escaped=""

  if ! line="$(latest_shutdown_log_line)"; then
    message="Welcome - no prior shutdown context found."
  else
    parse_shutdown_context_from_line "$line" || true
    message="$(append_welcome_section "Yesterday you closed with:" "${last_shutdown_task_text:-}" "$message")"
    message="$(append_welcome_section "Next step you planned:" "${last_shutdown_tomorrow_first_step:-}" "$message")"
    message="$(append_welcome_section "Open loop parked:" "${last_shutdown_open_items:-}" "$message")"
    if [[ -z "$message" ]]; then
      message="Welcome back. Last shutdown context was empty."
      if [[ -n "${last_shutdown_ts:-}" ]]; then
        message="$message"$'\n'"Last shutdown timestamp: ${last_shutdown_ts}"
      fi
    fi
  fi

  escaped="$(printf '%s' "$message" | sed 's/\\/\\\\/g; s/"/\\"/g')"
  if command -v osascript >/dev/null 2>&1; then
    if osascript <<APPLESCRIPT >/dev/null 2>&1
display dialog "$escaped" with title "Welcome back" buttons {"OK"} default button "OK" giving up after $timeout
APPLESCRIPT
    then
      return 0
    fi
  fi

  printf '\n[Welcome back]\n%s\n\n' "$message"
  return 1
}

run_escalation_break_timer() {
  local seconds="${1:-150}"
  sleep "$seconds"
  notify_message "Back to it-what's next?" "Work Chill"
  printf '%s escalation_break_complete seconds=%s\n' "$(iso_ts)" "$seconds" >> "$BG_LOG_FILE" 2>/dev/null || true
}

trigger_escalation() {
  local reason="${1:-}"
  local choice=""
  local input_text=""
  local break_secs=0

  load_state
  last_escalation_ts="$(date +%s)"
  save_state

  bg_log "escalation_trigger reason=\"$reason\""
  choice="$(get_escalation_choice)"

  case "$choice" in
    "2-min break")
      notify_message "2 minutes-breathe." "Work Chill"
      open "$ESCALATION_BREAK_URL" >/dev/null 2>&1 || true
      break_secs="$(escalation_break_timer_sec)"
      nohup "$SCRIPT_PATH" __escalation-break-timer "$break_secs" >> "$BG_LOG_FILE" 2>&1 &
      disown "$!" 2>/dev/null || true
      log_event "ESCALATION" "break" "" "" ""
      ;;
    "Name blocker")
      input_text="$(get_text_input "What's the blocker in 1 sentence?" "Quick reset")"
      log_event "ESCALATION" "blocker" "$input_text" "" ""
      ;;
    "Next micro-step")
      input_text="$(get_text_input "What's the next smallest step?" "Quick reset")"
      log_event "ESCALATION" "next_step" "$input_text" "" ""
      ;;
    *)
      log_event "ESCALATION" "ignore" "" "" ""
      ;;
  esac
}

hand_yoga_in_quiet_window() {
  local now="${1:-}"
  local last_prompt=0
  local last_escalation=0

  last_prompt="$(int_or_default "${last_prompt_ts:-}" "0")"
  if (( last_prompt > 0 )); then
    if (( now - last_prompt < 300 )); then
      return 0
    fi
  fi

  last_escalation="$(int_or_default "${last_escalation_ts:-}" "0")"
  if (( last_escalation > 0 )); then
    if (( now - last_escalation < 600 )); then
      return 0
    fi
  fi

  return 1
}

defer_hand_yoga_quiet_window() {
  local now="${1:-}"
  local defer_secs=0
  local target=0
  local existing=0
  defer_secs="$(hand_yoga_defer_sec)"
  target=$((now + defer_secs))
  existing="$(int_or_default "${hand_yoga_snoozed_until:-}" "0")"
  if (( existing > target )); then
    target="$existing"
  fi
  hand_yoga_snoozed_until="$target"
  save_state
}

hand_yoga_due_now() {
  local now="${1:-}"
  local interval=0
  local max_per_day=0
  local count_today=0
  local snoozed_until=0
  local last_ts=0

  hand_yoga_enabled || return 1
  interval="$(state_hand_yoga_interval_secs)"
  max_per_day="$(state_hand_yoga_max_per_day)"
  count_today="$(int_or_default "${hand_yoga_count_today:-}" "0")"
  if (( count_today >= max_per_day )); then
    return 1
  fi

  snoozed_until="$(int_or_default "${hand_yoga_snoozed_until:-}" "0")"
  if (( snoozed_until > now )); then
    return 1
  fi

  last_ts="$(int_or_default "${last_hand_yoga_ts:-}" "0")"
  if (( last_ts <= 0 )); then
    return 1
  fi

  if (( now - last_ts >= interval )); then
    return 0
  fi
  return 1
}

next_hand_yoga_sleep_secs() {
  local now="${1:-}"
  local interval=0
  local max_per_day=0
  local count_today=0
  local snoozed_until=0
  local last_ts=0
  local due_at=0
  local sleep_for=60
  local until_due=0
  local until_snooze=0

  hand_yoga_enabled || { printf '1'; return 0; }
  max_per_day="$(state_hand_yoga_max_per_day)"
  count_today="$(int_or_default "${hand_yoga_count_today:-}" "0")"
  if (( count_today >= max_per_day )); then
    printf '1'
    return 0
  fi

  interval="$(state_hand_yoga_interval_secs)"
  last_ts="$(int_or_default "${last_hand_yoga_ts:-}" "0")"
  if (( last_ts <= 0 )); then
    printf '30'
    return 0
  fi
  due_at=$((last_ts + interval))
  until_due=$((due_at - now))
  if (( until_due < 1 )); then
    until_due=1
  fi

  snoozed_until="$(int_or_default "${hand_yoga_snoozed_until:-}" "0")"
  if (( snoozed_until > now )); then
    until_snooze=$((snoozed_until - now))
    if (( due_at <= now )); then
      sleep_for="$until_snooze"
    elif (( until_snooze < until_due )); then
      sleep_for="$until_snooze"
    else
      sleep_for="$until_due"
    fi
  else
    sleep_for="$until_due"
  fi

  if (( sleep_for < 1 )); then
    sleep_for=1
  fi
  if (( sleep_for > 300 )); then
    sleep_for=300
  fi
  printf '%s' "$sleep_for"
}

handle_hand_yoga_due() {
  local now="${1:-}"
  local action=""
  local snooze_secs=0

  if hand_yoga_in_quiet_window "$now"; then
    defer_hand_yoga_quiet_window "$now"
    return 0
  fi

  action="$(get_hand_yoga_action)"
  case "$action" in
    "Do it now")
      open "$hand_yoga_url" >/dev/null 2>&1 || true
      hand_yoga_count_today="$(int_or_default "${hand_yoga_count_today:-}" "0")"
      hand_yoga_count_today=$((hand_yoga_count_today + 1))
      last_hand_yoga_ts="$now"
      hand_yoga_snoozed_until=""
      save_state
      log_event "HAND_YOGA" "start" "" "" ""
      ;;
    "Skip today")
      hand_yoga_count_today="$(state_hand_yoga_max_per_day)"
      hand_yoga_snoozed_until=""
      save_state
      log_event "HAND_YOGA" "skip_day" "" "" ""
      ;;
    *)
      snooze_secs="$(hand_yoga_snooze_sec)"
      hand_yoga_snoozed_until="$((now + snooze_secs))"
      save_state
      log_event "HAND_YOGA" "snooze" "" "" ""
      ;;
  esac
}

run_task_pulse() {
  load_state
  local action=""
  local task_text=""
  local now=""
  local should_escalate="no"
  local escalation_reason=""

  action="$(get_action_choice)"
  now="$(date +%s)"
  case "$action" in
    "Same as last")
      task_text="${last_task_text:-}"
      if [[ -z "$task_text" ]]; then
        task_text="$(get_text_input "Enter current task:" "Friction Check")"
      fi
      consecutive_same_count="$(int_or_default "${consecutive_same_count:-}" "0")"
      consecutive_same_count=$((consecutive_same_count + 1))
      last_action="same_as_last"
      if [[ "$consecutive_same_count" -ge 3 ]]; then
        should_escalate="yes"
        escalation_reason="same_as_last_${consecutive_same_count}"
      fi
      last_task_text="$task_text"
      last_prompt_ts="$now"
      save_state
      log_event "TASK_PULSE" "same_as_last" "$task_text" "" ""
      ;;
    "New task")
      task_text="$(get_text_input "Enter current task:" "Friction Check")"
      consecutive_same_count="0"
      last_action="new_task"
      last_task_text="$task_text"
      last_prompt_ts="$now"
      save_state
      log_event "TASK_PULSE" "new_task" "$task_text" "" ""
      ;;
    "Stuck")
      task_text="${last_task_text:-}"
      if [[ -z "$task_text" ]]; then
        task_text="$(get_text_input "Enter current task:" "Friction Check")"
      fi
      consecutive_same_count="0"
      last_action="stuck"
      should_escalate="yes"
      escalation_reason="stuck"
      last_task_text="$task_text"
      last_prompt_ts="$now"
      save_state
      log_event "TASK_PULSE" "stuck" "$task_text" "" ""
      ;;
    *)
      consecutive_same_count="0"
      last_action="skip"
      last_prompt_ts="$now"
      save_state
      log_event "TASK_PULSE_SKIPPED" "skip" "" "" ""
      ;;
  esac

  if [[ "$should_escalate" == "yes" ]]; then
    trigger_escalation "$escalation_reason"
  fi
}

start_prompt_loop_bg() {
  local start_ts="${1:-}"
  local interval="${2:-}"
  if [[ -z "$interval" ]]; then
    interval="$(state_prompt_interval_secs)"
  fi
  nohup "$SCRIPT_PATH" __prompt-loop "$start_ts" "$interval" >> "$BG_LOG_FILE" 2>&1 &
  prompt_pid="$!"
  disown "$prompt_pid" 2>/dev/null || true
}

start_eod_bg() {
  local start_ts="${1:-}"
  local length="${2:-}"
  if [[ -z "$length" ]]; then
    length="$(day_length_sec)"
  fi
  nohup "$SCRIPT_PATH" __eod-wait "$start_ts" "$length" >> "$BG_LOG_FILE" 2>&1 &
  eod_pid="$!"
  disown "$eod_pid" 2>/dev/null || true
}

start_hand_yoga_bg() {
  local start_ts="${1:-}"
  hand_yoga_enabled || return 0
  nohup "$SCRIPT_PATH" __hand-yoga-loop "$start_ts" >> "$BG_LOG_FILE" 2>&1 &
  hand_yoga_pid="$!"
  disown "$hand_yoga_pid" 2>/dev/null || true
}

run_start() {
  local end_at=""
  local eod_wait=""
  local interval=""

  while [[ "$#" -gt 0 ]]; do
    case "${1:-}" in
      --end-at)
        if [[ "$#" -lt 2 || -z "${2:-}" ]]; then
          printf 'Usage: work_chill start [--end-at HH:MM]\n' >&2
          exit 1
        fi
        end_at="$2"
        shift 2
        ;;
      --end-at=*)
        end_at="${1#*=}"
        shift
        ;;
      *)
        printf 'Usage: work_chill start [--end-at HH:MM]\n' >&2
        exit 1
        ;;
    esac
  done

  if [[ -n "$end_at" ]]; then
    if ! is_valid_hhmm "$end_at"; then
      printf 'Invalid --end-at value: %s (expected HH:MM, 24-hour)\n' "$end_at" >&2
      exit 1
    fi
    eod_wait="$(seconds_until_end_at "$end_at" || true)"
    if [[ -z "$eod_wait" || "$eod_wait" -le 0 ]]; then
      printf 'Unable to schedule end-of-day for %s\n' "$end_at" >&2
      exit 1
    fi
  else
    eod_wait="$(day_length_sec)"
  fi

  ensure_data_dir
  load_state

  if [[ -n "${day_start_ts:-}" ]]; then
    cancel_jobs_only
  fi

  show_welcome_back_summary || true

  day_start_ts="$(date +%s)"
  interval="$(prompt_interval_sec)"
  day_length_secs="$eod_wait"
  prompt_interval_secs="$interval"
  last_prompt_ts=""
  hand_yoga_pid=""
  hand_yoga_interval_secs="$(hand_yoga_interval_sec)"
  hand_yoga_max_per_day="2"
  hand_yoga_count_today="0"
  hand_yoga_snoozed_until=""
  last_hand_yoga_ts="$day_start_ts"
  last_escalation_ts=""
  paused="no"
  pause_started_ts=""
  paused_total_secs="0"
  consecutive_same_count="0"
  last_action=""
  save_state

  start_prompt_loop_bg "$day_start_ts" "$interval"
  start_eod_bg "$day_start_ts" "$eod_wait"
  start_hand_yoga_bg "$day_start_ts"
  save_state

  log_event "DAY_START" "start" "" "" ""

  printf 'Work day started at %s\n' "$(date -r "$day_start_ts" +"%Y-%m-%d %H:%M:%S")"
  if [[ -n "$end_at" ]]; then
    printf 'End-of-day scheduled for %s (in %s seconds)\n' "$end_at" "$eod_wait"
  fi
  if is_test_mode; then
    printf 'TEST MODE: prompt interval=10s, day length=2m, meditation timer=15s, escalation break=10s, hand yoga interval=30s, hand yoga snooze=5s\n'
  fi
}

format_elapsed() {
  local secs="${1:-0}"
  local h m s
  h=$((secs / 3600))
  m=$(( (secs % 3600) / 60 ))
  s=$((secs % 60))
  printf '%02dh %02dm %02ds' "$h" "$m" "$s"
}

status_line_pid() {
  local label="${1:-}"
  local pid="${2:-}"
  local marker="${3:-}"
  if pid_looks_like_work_chill "$pid" "$marker"; then
    printf '%s: %s (alive)\n' "$label" "$pid"
  elif pid_alive "$pid"; then
    printf '%s: %s (alive, non-matching cmd)\n' "$label" "$pid"
  else
    printf '%s: %s (not running)\n' "$label" "${pid:-<none>}"
  fi
}

run_status() {
  load_state
  local now elapsed active active_elapsed remaining paused_total effective_pause_total
  now="$(date +%s)"

  if [[ -n "${day_start_ts:-}" ]]; then
    elapsed=$((now - day_start_ts))
    if (( elapsed < 0 )); then
      elapsed=0
    fi
    active="yes"
    active_elapsed="$(compute_active_elapsed_secs "$now")"
    remaining="$(compute_remaining_secs "$now")"
    paused_total="$(int_or_default "${paused_total_secs:-}" "0")"
    effective_pause_total="$(effective_paused_total_secs "$now")"
    printf 'day_active: %s\n' "$active"
    printf 'start_time: %s\n' "$(date -r "$day_start_ts" +"%Y-%m-%d %H:%M:%S")"
    printf 'elapsed: %s\n' "$(format_elapsed "$elapsed")"
    printf 'paused: %s\n' "${paused:-no}"
    printf 'paused_total_secs: %s\n' "$paused_total"
    if [[ "${paused:-no}" == "yes" ]]; then
      printf 'pause_started_at: %s\n' "$(date -r "${pause_started_ts:-$now}" +"%Y-%m-%d %H:%M:%S")"
      printf 'timers: paused\n'
      printf 'effective_paused_total_secs: %s\n' "$effective_pause_total"
    else
      printf 'pause_started_at: <none>\n'
    fi
    printf 'active_elapsed_secs: %s\n' "$active_elapsed"
    printf 'active_elapsed: %s\n' "$(format_elapsed "$active_elapsed")"
    printf 'remaining_secs: %s\n' "$remaining"
    printf 'remaining: %s\n' "$(format_elapsed "$remaining")"
    printf 'day_length_secs: %s\n' "$(state_day_length_secs)"
    printf 'prompt_interval_secs: %s\n' "$(state_prompt_interval_secs)"
  else
    active="no"
    printf 'day_active: %s\n' "$active"
    printf 'start_time: <none>\n'
    printf 'elapsed: 00h 00m 00s\n'
    printf 'paused: no\n'
    printf 'paused_total_secs: 0\n'
    printf 'pause_started_at: <none>\n'
    printf 'active_elapsed_secs: 0\n'
    printf 'active_elapsed: 00h 00m 00s\n'
    printf 'remaining_secs: 0\n'
    printf 'remaining: 00h 00m 00s\n'
    printf 'day_length_secs: %s\n' "$(state_day_length_secs)"
    printf 'prompt_interval_secs: %s\n' "$(state_prompt_interval_secs)"
  fi

  status_line_pid "prompt_pid" "${prompt_pid:-}" "__prompt-loop"
  status_line_pid "eod_pid" "${eod_pid:-}" "__eod-wait"
  status_line_pid "hand_yoga_pid" "${hand_yoga_pid:-}" "__hand-yoga-loop"

  printf 'last_task_text: %s\n' "${last_task_text:-<none>}"
  if [[ -n "${last_prompt_ts:-}" ]]; then
    printf 'last_prompt_at: %s\n' "$(date -r "$last_prompt_ts" +"%Y-%m-%d %H:%M:%S")"
  else
    printf 'last_prompt_at: <none>\n'
  fi

  if [[ -n "${meditation_url:-}" ]]; then
    printf 'meditation_url_set: yes\n'
    printf 'meditation_url: %s\n' "$meditation_url"
  else
    printf 'meditation_url_set: no\n'
  fi
  if [[ -n "${hand_yoga_url:-}" ]]; then
    printf 'hand_yoga_url_set: yes\n'
    printf 'hand_yoga_url: %s\n' "$hand_yoga_url"
  else
    printf 'hand_yoga_url_set: no\n'
    printf 'hand_yoga_url: <none>\n'
  fi
  printf 'hand_yoga_count_today: %s\n' "$(int_or_default "${hand_yoga_count_today:-}" "0")"
  printf 'consecutive_same_count: %s\n' "$(int_or_default "${consecutive_same_count:-}" "0")"
  printf 'last_action: %s\n' "${last_action:-<none>}"
  printf 'state_file: %s\n' "$STATE_FILE"
  printf 'log_file: %s\n' "$LOG_FILE"
}

run_meditation_timer() {
  local seconds="${1:-360}"
  sleep "$seconds"
  notify_message "Meditation complete." "Work Chill"
  printf '%s meditation_complete seconds=%s\n' "$(iso_ts)" "$seconds" >> "$BG_LOG_FILE" 2>/dev/null || true
}

start_meditation_best_effort() {
  load_state
  local seconds
  seconds="$(meditation_timer_sec)"
  if [[ -n "${meditation_url:-}" ]]; then
    open "$meditation_url" >/dev/null 2>&1 || true
    nohup "$SCRIPT_PATH" __meditation-timer "$seconds" >> "$BG_LOG_FILE" 2>&1 &
    disown "$!" 2>/dev/null || true
  fi
}

shutdown_flow() {
  local action="${1:-manual}"
  load_state

  local tomorrow_first_step=""
  local open_items=""

  tomorrow_first_step="$(get_text_input "Tomorrow first step:" "Shutdown")"
  open_items="$(get_text_input "Known open items intentionally parked:" "Shutdown")"
  confirm_ok "Work is parked." "Shutdown"

  log_event "SHUTDOWN" "$action" "${last_task_text:-}" "$tomorrow_first_step" "$open_items"

  cancel_jobs_only
  reset_active_day_state
  save_state

  start_meditation_best_effort
}

run_shutdown() {
  shutdown_flow "manual"
  printf 'Shutdown complete.\n'
}

run_cancel() {
  load_state
  cancel_jobs_only
  reset_active_day_state
  save_state
  log_event "CANCEL" "cancel" "" "" ""
  printf 'Cancelled active jobs and cleared active day state.\n'
}

run_pause() {
  load_state
  local now=""
  local active_elapsed=""

  if [[ -z "${day_start_ts:-}" ]]; then
    printf 'No active day to pause.\n'
    return 0
  fi

  if [[ "${paused:-no}" == "yes" ]]; then
    printf 'Day is already paused.\n'
    return 0
  fi

  now="$(date +%s)"
  active_elapsed="$(compute_active_elapsed_secs "$now")"
  paused="yes"
  pause_started_ts="$now"
  cancel_jobs_in_memory
  save_state
  log_event "PAUSE" "pause" "$active_elapsed" "" ""

  printf 'Paused active timers at %s.\n' "$(date -r "$now" +"%Y-%m-%d %H:%M:%S")"
}

run_resume() {
  load_state
  local now=""
  local pause_started=0
  local paused_total=0
  local paused_delta=0
  local remaining=0
  local interval=0

  if [[ -z "${day_start_ts:-}" ]]; then
    printf 'No active day to resume.\n'
    return 0
  fi

  if [[ "${paused:-no}" != "yes" ]]; then
    printf 'Day is not paused.\n'
    return 0
  fi

  now="$(date +%s)"
  pause_started="$(int_or_default "${pause_started_ts:-}" "0")"
  if (( pause_started > 0 && now > pause_started )); then
    paused_delta=$((now - pause_started))
  fi
  paused_total="$(int_or_default "${paused_total_secs:-}" "0")"
  paused_total_secs="$((paused_total + paused_delta))"
  pause_started_ts=""
  paused="no"
  if [[ -n "${last_hand_yoga_ts:-}" && "${last_hand_yoga_ts:-}" =~ ^[0-9]+$ && "$paused_delta" -gt 0 ]]; then
    last_hand_yoga_ts="$((last_hand_yoga_ts + paused_delta))"
  fi

  interval="$(state_prompt_interval_secs)"
  remaining="$(compute_remaining_secs "$now")"
  cancel_jobs_in_memory

  if (( remaining <= 0 )); then
    save_state
    log_event "RESUME" "resume" "$paused_delta" "" ""
    printf 'No remaining active work time; triggering shutdown.\n'
    "$SCRIPT_PATH" __shutdown "auto" >/dev/null 2>&1 || true
    return 0
  fi

  start_prompt_loop_bg "$day_start_ts" "$interval"
  start_eod_bg "$day_start_ts" "$remaining"
  start_hand_yoga_bg "$day_start_ts"
  save_state
  log_event "RESUME" "resume" "$paused_delta" "" ""

  printf 'Resumed active timers. Remaining active time: %s.\n' "$(format_elapsed "$remaining")"
}

run_debug_prompt() {
  run_task_pulse
  printf 'Debug prompt executed.\n'
}

run_set_meditation_url() {
  local url="${*:-}"
  if [[ -z "$url" ]]; then
    printf 'Usage: work_chill set-meditation-url "<url>"\n' >&2
    exit 1
  fi
  load_state
  meditation_url="$url"
  save_state
  printf 'Meditation URL set.\n'
}

run_clear_meditation_url() {
  load_state
  meditation_url=""
  save_state
  printf 'Meditation URL cleared.\n'
}

run_set_hand_yoga_url() {
  local url="${*:-}"
  local had_url="no"
  if [[ -z "$url" ]]; then
    printf 'Usage: work_chill hand-yoga-url set "<url>"\n' >&2
    exit 1
  fi

  load_state
  if [[ -n "${hand_yoga_url:-}" ]]; then
    had_url="yes"
  fi
  hand_yoga_url="$url"

  if [[ -n "${day_start_ts:-}" && "$had_url" == "no" ]]; then
    hand_yoga_count_today="0"
    hand_yoga_snoozed_until=""
    last_hand_yoga_ts="$(date +%s)"
  fi

  if [[ -n "${day_start_ts:-}" && "${paused:-no}" != "yes" ]]; then
    kill_pid_if_ours "${hand_yoga_pid:-}" "__hand-yoga-loop"
    hand_yoga_pid=""
    start_hand_yoga_bg "$day_start_ts"
  fi

  save_state
  printf 'Hand yoga URL set.\n'
}

run_clear_hand_yoga_url() {
  load_state
  hand_yoga_url=""
  hand_yoga_snoozed_until=""
  kill_pid_if_ours "${hand_yoga_pid:-}" "__hand-yoga-loop"
  hand_yoga_pid=""
  save_state
  printf 'Hand yoga URL cleared.\n'
}

run_show_hand_yoga_url() {
  load_state
  if [[ -n "${hand_yoga_url:-}" ]]; then
    printf '%s\n' "$hand_yoga_url"
  else
    printf '<not set>\n'
  fi
}

run_hand_yoga_url() {
  local sub="${1:-}"
  case "$sub" in
    set)
      shift || true
      run_set_hand_yoga_url "$@"
      ;;
    clear)
      run_clear_hand_yoga_url
      ;;
    show)
      run_show_hand_yoga_url
      ;;
    *)
      printf 'Usage: work_chill hand-yoga-url <set|clear|show> [url]\n' >&2
      exit 1
      ;;
  esac
}

run_tail() {
  ensure_data_dir
  tail -n 50 -f "$LOG_FILE"
}

run_doctor() {
  local failures=0

  printf 'work_chill doctor\n'

  if command -v osascript >/dev/null 2>&1; then
    printf '[ok] osascript available: %s\n' "$(command -v osascript)"
  else
    printf '[fail] osascript not found\n'
    failures=$((failures + 1))
  fi

  if command -v open >/dev/null 2>&1; then
    printf '[ok] open available: %s\n' "$(command -v open)"
  else
    printf '[fail] open command not found\n'
    failures=$((failures + 1))
  fi

  if command -v work_chill >/dev/null 2>&1; then
    printf '[ok] work_chill on PATH: %s\n' "$(command -v work_chill)"
  else
    printf '[fail] work_chill not found on PATH\n'
    failures=$((failures + 1))
  fi

  case ":$PATH:" in
    *":$HOME/bin:"*) printf '[ok] ~/bin present in PATH\n' ;;
    *)
      printf '[fail] ~/bin missing from PATH\n'
      failures=$((failures + 1))
      ;;
  esac

  if mkdir -p "$DATA_DIR" 2>/dev/null; then
    printf '[ok] data dir ready: %s\n' "$DATA_DIR"
  else
    printf '[fail] cannot create/access data dir: %s\n' "$DATA_DIR"
    failures=$((failures + 1))
  fi

  if [[ -f "$STATE_FILE" ]] || touch "$STATE_FILE" 2>/dev/null; then
    if [[ -w "$STATE_FILE" ]]; then
      printf '[ok] state file writable: %s\n' "$STATE_FILE"
    else
      printf '[fail] state file not writable: %s\n' "$STATE_FILE"
      failures=$((failures + 1))
    fi
  else
    printf '[fail] cannot create state file: %s\n' "$STATE_FILE"
    failures=$((failures + 1))
  fi

  if [[ -f "$LOG_FILE" ]] || touch "$LOG_FILE" 2>/dev/null; then
    if [[ -w "$LOG_FILE" ]]; then
      printf '[ok] log file writable: %s\n' "$LOG_FILE"
    else
      printf '[fail] log file not writable: %s\n' "$LOG_FILE"
      failures=$((failures + 1))
    fi
  else
    printf '[fail] cannot create log file: %s\n' "$LOG_FILE"
    failures=$((failures + 1))
  fi

  if [[ -L "$LOG_FILE_LINK" ]]; then
    printf '[ok] log symlink: %s -> %s\n' "$LOG_FILE_LINK" "$(readlink "$LOG_FILE_LINK" 2>/dev/null || true)"
  else
    printf '[fail] log symlink missing: %s\n' "$LOG_FILE_LINK"
    failures=$((failures + 1))
  fi

  if [[ -r "$STATE_FILE" ]]; then
    if bash -n "$STATE_FILE" >/dev/null 2>&1; then
      printf '[ok] state file syntax parseable\n'
    else
      printf '[fail] state file syntax invalid: %s\n' "$STATE_FILE"
      failures=$((failures + 1))
    fi
  fi

  load_state
  if [[ -n "${hand_yoga_url:-}" ]]; then
    printf '[ok] hand yoga URL configured\n'
  else
    printf '[ok] hand yoga URL not configured (feature off)\n'
  fi

  if [[ "$failures" -eq 0 ]]; then
    printf 'doctor_result: healthy\n'
    return 0
  fi

  printf 'doctor_result: issues_found (%s)\n' "$failures"
  return 1
}

run_help() {
  cat <<'EOF'
work_chill - personal work pacing helper

Commands:
  work_chill start [--end-at HH:MM]
  work_chill pause
  work_chill resume
  work_chill status
  work_chill shutdown
  work_chill cancel
  work_chill debug-prompt
  work_chill hand-yoga-url set "<url>"
  work_chill hand-yoga-url clear
  work_chill hand-yoga-url show
  work_chill set-meditation-url "<url>"
  work_chill clear-meditation-url
  work_chill tail
  work_chill doctor
  work_chill help

State + logs:
  ~/.work_chill/state.sh
  ~/.work_chill/logs/YYYY-Www.jsonl
  ~/.work_chill/log.jsonl (symlink to current week)
  ~/.work_chill/bg.log

Testing mode:
  WORK_CHILL_TEST=1
  - prompt interval: 10 seconds
  - day length: 2 minutes (unless --end-at is provided)
  - meditation timer: 15 seconds
  - escalation break timer: 10 seconds
  - hand yoga interval: 30 seconds (if URL set)
  - hand yoga snooze: 5 seconds
EOF
}

run_prompt_loop() {
  local start_ts="${1:-}"
  local interval="${2:-}"
  if [[ -z "$interval" ]]; then
    interval="$(state_prompt_interval_secs)"
  fi

  while true; do
    sleep "$interval"
    load_state
    if [[ -z "${day_start_ts:-}" || "${day_start_ts:-}" != "$start_ts" ]]; then
      exit 0
    fi
    run_task_pulse
  done
}

run_eod_wait() {
  local start_ts="${1:-}"
  local length="${2:-}"
  if [[ -z "$length" ]]; then
    length="$(day_length_sec)"
  fi
  sleep "$length"
  load_state
  if [[ -n "${day_start_ts:-}" && "${day_start_ts:-}" == "$start_ts" ]]; then
    "$SCRIPT_PATH" __shutdown "auto" >/dev/null 2>&1 || true
  fi
}

run_hand_yoga_loop() {
  local start_ts="${1:-}"
  local now=0
  local sleep_for=0
  local count_today=0
  local max_per_day=0

  while true; do
    load_state
    if [[ -z "${day_start_ts:-}" || "${day_start_ts:-}" != "$start_ts" ]]; then
      exit 0
    fi
    if [[ "${paused:-no}" == "yes" ]]; then
      exit 0
    fi
    if ! hand_yoga_enabled; then
      exit 0
    fi

    count_today="$(int_or_default "${hand_yoga_count_today:-}" "0")"
    max_per_day="$(state_hand_yoga_max_per_day)"
    if (( count_today >= max_per_day )); then
      exit 0
    fi

    now="$(date +%s)"
    if hand_yoga_due_now "$now"; then
      handle_hand_yoga_due "$now"
      continue
    fi

    sleep_for="$(next_hand_yoga_sleep_secs "$now")"
    sleep "$sleep_for"
  done
}

internal_shutdown() {
  local mode="${1:-auto}"
  shutdown_flow "$mode"
}

main() {
  SCRIPT_PATH="$(resolve_script_path)"
  ensure_data_dir
  local cmd="${1:-help}"
  shift || true

  case "$cmd" in
    start) run_start "$@" ;;
    pause) run_pause ;;
    resume) run_resume ;;
    status) run_status ;;
    shutdown) run_shutdown ;;
    cancel) run_cancel ;;
    debug-prompt) run_debug_prompt ;;
    hand-yoga-url) run_hand_yoga_url "$@" ;;
    set-meditation-url) run_set_meditation_url "$@" ;;
    clear-meditation-url) run_clear_meditation_url ;;
    tail) run_tail ;;
    doctor) run_doctor ;;
    help|-h|--help) run_help ;;
    __prompt-loop) run_prompt_loop "${1:-}" "${2:-}" ;;
    __eod-wait) run_eod_wait "${1:-}" "${2:-}" ;;
    __hand-yoga-loop) run_hand_yoga_loop "${1:-}" ;;
    __shutdown) internal_shutdown "${1:-auto}" ;;
    __meditation-timer) run_meditation_timer "${1:-360}" ;;
    __escalation-break-timer) run_escalation_break_timer "${1:-150}" ;;
    *)
      printf 'Unknown command: %s\n\n' "$cmd" >&2
      run_help
      exit 1
      ;;
  esac
}

main "$@"
